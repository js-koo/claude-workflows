# pr-resolver 요구사항 정의서

## 1. 개요

| 항목 | 내용 |
|------|------|
| 이름 | pr-resolver |
| 유형 | Claude Code Custom Command |
| 목적 | PR 리뷰 코멘트 확인, 코드 수정, 답글 처리 자동화 |
| 호출 | `/pr-resolver [help\|config\|PR번호]` |

---

## 2. 실행 환경

| 항목 | 요구사항 |
|------|----------|
| Git | git repo 내에서 실행 |
| GitHub CLI | gh 인증 완료 상태 |
| 권한 | repo read/write |

---

## 3. 명령어

| 명령어 | 설명 |
|--------|------|
| `/pr-resolver` | PR 자동 감지 후 코멘트 처리 |
| `/pr-resolver 2874` | 특정 PR 코멘트 처리 |
| `/pr-resolver help` | 도움말 표시 |
| `/pr-resolver config` | 현재 설정 보기 |
| `/pr-resolver config lang ko` | 언어 변경 |
| `/pr-resolver config action <name> <enable\|disable>` | 액션 활성화/비활성화 |
| `/pr-resolver config action <name> reaction <value>` | 리액션 변경 |
| `/pr-resolver config reset` | 설정 초기화 |

---

## 4. 실행 흐름

```
┌─────────────────────────────────────────────────────────────┐
│ 1. PR 번호 감지                                              │
│    └─ 인자 있음 → 사용                                       │
│    └─ 인자 없음 → 자동 감지 → 실패시 입력 요청               │
├─────────────────────────────────────────────────────────────┤
│ 2. 코멘트 조회 및 목록 표시                                   │
│    └─ 번호, 파일명, 내용 요약                                │
├─────────────────────────────────────────────────────────────┤
│ 3. 사용자 선택                                               │
│    ├─ 3-1. 처리할 코멘트 선택                                │
│    └─ 3-2. 행동 선택 (Fixed/Will fix later/Explain/...)     │
├─────────────────────────────────────────────────────────────┤
│ 4. 코멘트 처리                                               │
│    ├─ 4-1. 리뷰어 코멘트 전체 표시                           │
│    ├─ 4-2. 언어 감지                                         │
│    ├─ 4-3. 코드 수정 (Fixed 액션 시)                         │
│    │       └─ [적용] [수정] [의견 추가] [건너뛰기]           │
│    ├─ 4-4. 커밋 (수정 적용 시)                               │
│    ├─ 4-5. 답글 생성                                         │
│    └─ 4-6. 답글 확인                                         │
│            └─ [전송] [수정] [의견 추가] [취소]               │
├─────────────────────────────────────────────────────────────┤
│ 5. 전송                                                      │
│    ├─ 답글 전송 (gh api .../replies)                        │
│    └─ 리액션 추가 (gh api .../reactions)                    │
├─────────────────────────────────────────────────────────────┤
│ 6. 반복                                                      │
│    └─ "다른 코멘트도 처리할까요?" → [예] [아니오]           │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 행동 목록

| 행동 | 설명 | 코드수정 | 답글 | 리액션 |
|------|------|----------|------|--------|
| Fixed | 코드 수정함 | ✅ | ✅ AI 제안 | 👍 |
| Will fix later | 다음에 반영 | ❌ | ✅ AI 제안 | 👀 |
| Explain | 이유 설명 | ❌ | ✅ 사용자 입력 | ❌ |
| Disagree | 동의 안 함 | ❌ | ✅ 사용자 입력 | ❌ |
| Skip | 이미 해결됨 | ❌ | ❌ | 👍 |
| Praise response | 감사 표시 | ❌ | ❌ | ❤️ |

---

## 6. 코드 수정 단계 (Fixed 액션)

```
┌─────────────────────────────────────────────────────────────┐
│  📝 리뷰어 코멘트 (전체)                                     │
│  ─────────────────────────────────────────────────────────  │
│  파일: Repository.kt:64                                      │
│  내용: SQL 인젝션 위험이 있습니다. 파라미터 바인딩을          │
│        사용해주세요...                                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  💡 제안 수정 코드                                           │
│  ─────────────────────────────────────────────────────────  │
│  - val query = "SELECT * FROM users WHERE id = " + id       │
│  + val query = "SELECT * FROM users WHERE id = :id"         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  [적용] [수정] [의견 추가] [건너뛰기]                         │
│                                                             │
│  • 적용 - 제안 코드 그대로 적용                              │
│  • 수정 - 제안 코드 수정 후 적용                             │
│  • 의견 추가 - 추가 컨텍스트 전달 → 코드 재생성              │
│  • 건너뛰기 - 이 코멘트 건너뛰고 다음으로                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 답글 확인 단계

```
┌─────────────────────────────────────────────────────────────┐
│  💬 제안 답글                                                │
│  ─────────────────────────────────────────────────────────  │
│  수정했습니다. abc1234 커밋을 확인해주세요.                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  [전송] [수정] [의견 추가] [취소]                             │
│                                                             │
│  • 전송 - 답글 그대로 전송                                   │
│  • 수정 - 답글 수정 후 전송                                  │
│  • 의견 추가 - 추가 컨텍스트 전달 → 답글 재생성              │
│  • 취소 - 답글 취소하고 다음 코멘트로                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 설정 (git config)

| 설정 키 | 설명 | 예시 |
|---------|------|------|
| `pr-resolver.lang` | 언어 (en/ko) | `ko` |
| `pr-resolver.action.{name}.enabled` | 액션 활성화 | `true` |
| `pr-resolver.action.{name}.reaction` | 리액션 | `+1`, `eyes`, `heart`, `rocket` |

---

## 9. GitHub API

| 용도 | API |
|------|-----|
| PR 정보 | `gh pr view --json number` |
| 코멘트 조회 | `gh api repos/{owner}/{repo}/pulls/{pr}/comments` |
| 답글 전송 | `gh api repos/{owner}/{repo}/pulls/{pr}/comments/{id}/replies -f body="..."` |
| 리액션 추가 | `gh api repos/{owner}/{repo}/pulls/{pr}/comments/{id}/reactions -f content="+1"` |

---

## 10. 에러 처리

| 상황 | 처리 |
|------|------|
| git repo 아님 | 에러 메시지 출력 |
| gh 미인증 | `gh auth login` 안내 |
| PR 없음 | PR 번호 입력 요청 |
| 코멘트 없음 | "처리할 코멘트가 없습니다" |
| API 실패 | 에러 메시지 + 재시도 안내 |

---

## 11. 허용 도구

```yaml
allowed-tools: Bash(gh:*), Bash(git:*)
```
